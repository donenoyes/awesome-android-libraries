<p><strong>Table of Contents</strong></p>
<ol>
  <li><a href="#early-days-of-android">Early days of Dynamic Animation</a></li>
  <li><a href="#android-stack">Producing Animation</a></li>
  <li><a href="#linux-kernel">Emergence of Lottie</a></li>
  <li><a href="#secure-element">After Effects and Bodymovin</a></li>
  <li><a href="#hardware-abstraction-layer">Bodymovin JSON attributes</a></li>
  <li><a href="#native-libraries">Layers</a></li>
  <li><a href="#runtime">Core Classes of Lottie</a></li>
  <li><a href="#framework">Screen Adaptation of Lottie Animations</a></li>
  <li><a href="#apps">Overview</a></li>
  <li><a href="#references">References</a></li>
  <li><a href="#contributions">Contributions</a></li>
  
</ol>
<br>
<p><strong>Understanding the internals of Lottie-Android and the workflow of Loading and Rendering the Animation file</strong> blog post aims to be the starting point for developers to get familiar with the core classes, methods of Lottie source code plus the understanding of After Effects plugin Bodymovin which exports JSON required by Lottie to work.</p>
<br><br>


<!-- SECTION HEADINGS -->
<h3 id="early-days-of-android">Early days of Dynamic Animation</h3>
<br>
<p>In the year 2014 with the release of Android 5.0 (API 21) Lollipop, <i><strong>Android supported Vector Drawables and Animated Vector Drawables.</strong></i></p>

<p>But even with the support for Animated Vector Drawables, <strong>making dynamic vector animation was not easy.</strong> It couldn't be loaded programmatically or over the internet.</p>

<p>Moreover, it had issues with resolving vector path transformation animation in Android 4.x</p>

<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/GVlSP7v.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="android-stack">Producing Animation</h3>
<br>

<p><strong>Some other ways to produce the animation effect were:</strong></p>

<p><strong>Using gifs:</strong> Gifs are rendered at a fixed size that can't be scaled up to match large and high-density screens. They were not an ideal replacement.</p>


<p><strong>Using image sequences:</strong> One of the ways to achieve animation effect is to divide the animation into multiple pictures, and then periodically replace the pictures drawn on the screen to form the animation. This method is very simple, but the shortcomings are obvious. Very memory consuming, so it wasn't recommended.</p>


<p><strong>Facebook Keyframes:</strong> They are now deprecated and had limited feature set. So, not a very ideal choice either.</p>

<p>The direct consequence of the above is that there was not a hint of dynamic vector animation in almost all the major apps, but until the emergence of Lottie.</p>



<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/AIm0SpV.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="linux-kernel">Emergence of Lottie</h3>
<br>
<p>Lottie is an animation rendering library open-sourced by Airbnb. With Android, it also supports iOS, React Native, Windows, and Web platforms.</p>

<p>Lottie currently supports rendering and playing After Effects animations. <strong>Lottie uses the JSON data exported by bodymovin, an After Effects plug-in as the animation data source.</strong></p>

<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/oQJRNJ6.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="secure-element">After Effects and Bodymovin</h3>
<br>
<p>bodymovin plug-in is an open-source library used to present various AE effects on the web. </p>

<p><strong>The high-level workflow from after effects to rendering on device is shown:</strong></p>


<p>Designers use After Effects to make animations and export JSON files. We can put the JSON file on the svg-sprite Lottie-Player and run it to see the effect.</p>

<p>The resources used by Lottie need to first <strong>convert the aep (After Effects Project) file generated by Adobe After Effects into a general JSON format file through bodymovin</strong></p>


<p>bodymovin exports the After Effects animation as a description of the animation, and the job of lottie-android is to translate the described animation with native code, and its core principle is canvas drawing.</p>


<p><strong>Lottie's animation is drawn by a pure canvas.</strong></p>


<p>The bodymovin export contains all the information of the animation, the keyframe information of the animation, how to do the animation, and what to do.</p>


<p><strong>All the data of the Model in Lottie comes from this bodymovin exported json (the corresponding Model is LottieComposition).</strong></p>


<br><br>

<!-- SECTION HEADINGS -->
<h3 id="hardware-abstraction-layer">Bodymovin JSON attributes</h3>
<br>
<p><strong>There are many attributes. Few are listed:</strong></p>


<h4>The outermost layer looks like this:</h4>

<p>The meaning of the attribute:</p>


<p><strong>v =</strong> version of bodymovin</p>


<p><strong>fr =</strong> Frame rate</p>


<p><strong>ip =</strong> Start keyframe</p>


<p><strong>op =</strong> End key frame</p>


<p><strong>w =</strong> Animation width</p>


<p><strong>h =</strong> Animation height</p>


<p><strong>assets =</strong> Animated picture resource information</p>


<p><strong>layers =</strong> Animation layer information</p>


<p>From here, you can get the width and height of the designed animation, frame-related information, information on the image resources needed by the animation, and layer information.</p>


<h4>Inside assets</h4>

<p>a) assets</p>

<p>Image resource information.</p>

<p><strong>related classes:</strong> LottieImageAsset, ImageAssetBitmapManager.</p>

<p>The meaning of the attribute:</p>


<p><strong>id =</strong> Picture id</p>
<p><strong>w =</strong> Picture width</p>
<p><strong>h =</strong> Picture height</p>
<p><strong>p =</strong> Picture name</p>

<h4>Inside layers</h4>

<p>b) layers</p>

<p>Layer information.</p>

<p><strong>related classes:</strong> BaseLayer.</p>

<p>The meaning of the attribute:</p>


<p><strong>nm =</strong> Layer name</p>
<p><strong>refId =</strong> Resource id</p>
<p><strong>ind =</strong> Layer id</p>
<p><strong>ip =</strong> The starting keyframe of the layer</p>
<p><strong>op =</strong> The ending keyframe of the layer</p>
<p><strong>st =</strong> StartFrame</p>


<p>Lottie is responsible for analyzing the animation data coming through JSON, calculating the state of each animation at a certain point in time, and accurately drawing it on the screen.</p>


<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/Ue5QW08.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="native-libraries">Layers</h3>
<br>
<p>To understand Lottie animation rendering, we must first understand an important concept in <strong>After Effects: Layer</strong></p>

<p>In After Effects, the concept of layers is similar to the concept of layers in Photoshop: layers are equivalent to a more fine-grained distinction for the overall image of the animation, and different types of elements are split with different shapes and solid colors.</p>

<p>Elements such as text, etc. are located in different layers, and all layers are superimposed in sequence to form the rendered image.</p>

<p>Modifying the properties of a layer will not affect other layers so that when performing animation, it is possible to perform different animation logic on each element in the image more clearly.</p>

<p><i>In Lottie, the concept of layers is abstracted into 6 classes in BaseLayer:</i></p>

<p><strong>1. ShapeLayer</strong></p>

<p><strong>2. CompositionLayer</strong></p>

<p><strong>3. SolidLayer</strong></p>

<p><strong>4. ImageLayer</strong></p>

<p><strong>5. NullLayer</strong></p>

<p><strong>6. TextLayer</strong></p>


<p>The corresponding relationship between them and the layers in After Effects is: </p>

<p><i>Note the naming might be slightly different.</i></p>

<p><strong>ShapeLayer: Shape layer</strong></p>
<p><strong>CompositionLayer: Precompose layer</strong></p>
<p><strong>SolidLayer: Solid-color Layer</strong></p>
<p><strong>ImageLayer: Image material layer</strong></p>
<p><strong>NullLayer: Empty layer</strong></p>
<p><strong>TextLayer: Text layer</strong></p>


<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/zFh2TFt.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="runtime">Core Classes of Lottie</h3>
<br>
<p>The following is a description of the three core classes in Lottie-Android:</p>

<p><strong>a) LottieComposition (which converts JSON to data object)</strong></p>

<p><strong>b) LottieDrawable (which converts data Object to Drawable)</strong></p>

<p><strong>c) LottieAnimationView (performs drawing)</strong></p>

<p>The data in the Json file is converted into a LottieComposition data object. This class provides a static method for parsing json. </p>
<p>LottieDrawable is responsible for drawing the data into a drawable. LottieDrawable inherits from Drawable.</p>
<p>TLottieAnimationView inherits from AppCompatImageView. LottieAnimationView is responsible for displaying the LottieDrawable.</p>



<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/4m1AHor.png">
</div>

<br><br>

<!-- SECTION HEADINGS -->
<h3 id="framework">Screen Adaptation of Lottie Animations</h3>
<br>
<p><strong>Lottie has already done the adaptation work on the Android platform.</strong></p>
<p>When parsing, the width and height will be multiplied by the density of the phone after reading the width and height. When using it, it decides whether the adapted width and height exceed the width and height of the screen and if it exceeds, then zooms. This guarantees Lottie's proper display effect on the Android platform. </p>
<p><strong>Lottie converts all px values to dp.</strong> </p>

<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/1f9bIX9.png">
</div>

<br><br>


<!-- SECTION HEADINGS -->
<h3 id="apps">Overview</h3>
<br>
<p>With Lottie, as long as designers use After Effects to design animations, export them with bodymovin, import them into assets, and write the following code to achieve it or simply add in XML then there is no need to write custom View nor to draw a Path and nor to calculate the points!</p>

<div class="row  justify-content-center">
  <img class="img-fluid text-center" src = "https://i.imgur.com/ZFBAdHs.png">
</div>


<br><br>

<!-- SECTION HEADINGS -->
<h3 id="references">References</h3>
<br>
<a href="https://developer.android.com/guide/platform" target="_blank" rel="nofollow">https://developer.android.com/guide/platform</a><br><br>
<a href="https://source.android.com/" target="_blank" rel="nofollow">https://source.android.com/</a><br><br>
<a href="https://en.wikipedia.org/wiki/Android_(operating_system)" target="_blank" rel="nofollow">https://en.wikipedia.org/wiki/Android_(operating_system)</a><br><br>
<a href="https://software.intel.com/content/www/us/en/develop/blogs/art-vs-dalvik-introducing-the-new-android-x86-runtime.html" target="_blank" rel="nofollow">https://software.intel.com/content/www/us/en/develop/blogs/art-vs-dalvik-introducing-the-new-android-x86-runtime.html</a><br><br>
<a href="http://newandroidbook.com/" target="_blank" rel="nofollow">http://newandroidbook.com/</a><br><br>
<a href="https://www.amazon.ca/Android-Security-Internals-Depth-Architecture/dp/1593275811" target="_blank" rel="nofollow">Android Security Internals: An In-Depth Guide to Android's Security Architecture</a><br><br>
<a href="https://www.amazon.ca/Embedded-Android-Porting-Extending-Customizing/dp/1449308295" target="_blank" rel="nofollow">Embedded Android: Porting, Extending, and Customizing </a><br><br>

<p><strong>Relevant Video on "Awesome Dev Notes" YouTube</strong></p>

<div class="embed-responsive embed-responsive-16by9">
    <iframe id="player" class="embed-responsive-item" src="https://www.youtube.com/embed/E2_SgFnFmxc" allowfullscreen allow=autoplay></iframe>
</div>

<br><br>


<!-- SECTION HEADINGS -->
<h3 id="contributions">Contributions</h3>
<br>
<p><strong><i>Contributions and Pull requests are welcomed at <a href="https://github.com/androiddevnotes" target="_blank" rel="nofollow">https://github.com/androiddevnotes</a> repositories!</i></strong></p>

<p>🐣</p>
